<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cart</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .table thead th {
        background: #f7f7f7;
      }
      .btn-danger {
        background: #c44536;
        border: none;
      }
      .btn-danger:hover {
        background: #a73729;
      }
      .cart-product-name {
        color: #c44536;
        font-size: 1.3rem;
      }
      .trash-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
      }
      .trash-btn svg {
        transition: fill 0.2s;
      }
      .trash-btn:hover svg {
        fill: #c44536;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <!-- Cart Table -->
        <div class="col-lg-8 mb-4">
          <div class="border rounded">
            <table class="table mb-0 align-middle" id="cartTable">
              <thead>
                <tr>
                  <th style="width: 60px">&nbsp;</th>
                  <th style="width: 170px">SHOPPING CART</th>
                  <th>PRODUCT NAME</th>
                  <th style="width: 130px" class="text-end">PRICE</th>
                </tr>
              </thead>
              <tbody id="cartItems">
                <!-- JS will load cart items here -->
              </tbody>
            </table>
          </div>
        </div>
        <!-- Cart Total -->
        <div class="col-lg-4">
          <div class="border rounded">
            <div class="p-3" style="background: #f7f7f7; font-weight: 700">
              CART TOTAL
            </div>
            <div class="p-3">
              <div class="d-flex justify-content-between mb-2">
                <span>Subtotal</span>
                <span class="fw-bold" id="subtotal">$0.00</span>
              </div>
              <hr />
              <div class="d-flex justify-content-between mb-3">
                <span style="font-size: 1.15rem; font-weight: 700"
                  >Grand Total</span
                >
                <span
                  style="font-size: 1.15rem; font-weight: 700"
                  id="grandtotal"
                  >$0.00</span
                >
              </div>
              <a
                href="payment.html"
                class="btn btn-danger w-100 py-2"
                style="font-size: 1.1rem"
              >
                Proceed to Checkout
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery (for AJAX) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      function renderCartItem(item) {
        return `
        <tr class="cart-item" data-id="${item.cart_item_id}">
          <td class="text-center align-middle">
            <button class="trash-btn" onclick="deleteItem(this, ${
              item.cart_item_id
            })">
              <svg width="28" height="28" fill="#aaa" viewBox="0 0 24 24">
                <path d="M10 2v2H4v2h16V4h-6V2h-4zm-6 6h16l-1.5 14h-13L4 8zm4 3v7h2v-7H8zm4 0v7h2v-7h-2z"/>
              </svg>
            </button>
          </td>
          <td>
            <img src="${
              item.image_url || "https://via.placeholder.com/170"
            }" alt="${
          item.title
        }" class="img-fluid rounded" style="max-width:170px;"/>
          </td>
          <td class="align-middle">
            <span class="cart-product-name">${item.title}</span>
          </td>
          <td class="align-middle text-end" style="font-size:1.2rem; font-weight:500;">
            <span class="product-price">$${parseFloat(item.price).toFixed(
              2
            )}</span>
          </td>
        </tr>
      `;
      }

      function loadCart() {
        $.getJSON("ajax/cart_get.php", function (items) {
          let html = "";
          let subtotal = 0;
          if (!items || items.length === 0) {
            html =
              '<tr><td colspan="4" class="py-5 text-center text-secondary">Your cart is empty.</td></tr>';
          } else {
            items.forEach((item) => {
              subtotal += parseFloat(item.price);
              html += renderCartItem(item);
            });
          }
          $("#cartItems").html(html);
          $("#subtotal").text("$" + subtotal.toFixed(2));
          $("#grandtotal").text("$" + subtotal.toFixed(2));
        });
      }

      function deleteItem(btn, cart_item_id) {
        if (
          confirm("Are you sure you want to remove this item from your cart?")
        ) {
          $.post("ajax/cart_delete.php", { cart_item_id }, function (res) {
            if (res.trim() === "ok") {
              $(btn).closest("tr").remove();
              updateTotals();
            } else {
              alert("Failed to delete");
            }
          });
        }
      }

      function updateTotals() {
        let subtotal = 0;
        $("#cartItems .product-price").each(function () {
          subtotal += parseFloat($(this).text().replace("$", ""));
        });
        $("#subtotal").text("$" + subtotal.toFixed(2));
        $("#grandtotal").text("$" + subtotal.toFixed(2));
      }

      $(function () {
        loadCart();
      });
    </script>
  </body>
</html>
